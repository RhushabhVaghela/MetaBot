============================= test session starts ==============================
platform linux -- Python 3.12.6, pytest-9.0.2, pluggy-1.6.0
rootdir: /mnt/d/MegaBot
configfile: pyproject.toml
plugins: asyncio-1.3.0, cov-7.0.0, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1250 items

tests/test_admin_handler.py ......................................       [  3%]
tests/test_agents.py ........                                            [  3%]
tests/test_backup_manager.py .................                           [  5%]
tests/test_chat_memory.py .................                              [  6%]
tests/test_config.py .....                                               [  6%]
tests/test_coverage_completion.py .....                                  [  7%]
tests/test_coverage_completion_final.py ...................              [  8%]
tests/test_coverage_gaps.py .............                                [  9%]
tests/test_dependencies_full.py ..........                               [ 10%]
tests/test_discord_adapter.py .......................................... [ 13%]
......................................................                   [ 18%]
tests/test_discovery.py ..                                               [ 18%]
tests/test_drivers.py ...................                                [ 19%]
tests/test_extra_llm_providers.py ....                                   [ 20%]
tests/test_fastapi_endpoints.py ....                                     [ 20%]
tests/test_instrumentation_discovery.py .....                            [ 20%]
tests/test_integration_adapters.py .....                                 [ 21%]
tests/test_interfaces.py ..                                              [ 21%]
tests/test_knowledge_memory.py ....................                      [ 23%]
tests/test_llm_providers.py ........................                     [ 25%]
tests/test_llm_providers_coverage.py .........                           [ 25%]
tests/test_llm_providers_new.py ......                                   [ 26%]
tests/test_loki.py ..................                                    [ 27%]
tests/test_main.py .                                                     [ 27%]
tests/test_mcp_adapter.py ......                                         [ 28%]
tests/test_mcp_server.py ..........................                      [ 30%]
tests/test_megabot_messaging.py ........................................ [ 33%]
........................................................................ [ 39%]
.........................................................                [ 43%]
tests/test_memory_logic.py .                                             [ 43%]
tests/test_memu_adapter.py .................                             [ 45%]
tests/test_messaging_imessage.py .....                                   [ 45%]
tests/test_messaging_server.py ..........................                [ 47%]
tests/test_messaging_server_coverage.py .................                [ 49%]
tests/test_messaging_sms.py .......                                      [ 49%]
tests/test_messaging_telegram.py ....................................... [ 52%]
....                                                                     [ 53%]
tests/test_nanobot_adapter.py ...........                                [ 54%]
tests/test_network_monitor.py ............                               [ 54%]
tests/test_network_server.py ........                                    [ 55%]
tests/test_network_tunnel.py ..............                              [ 56%]
tests/test_openclaw_adapter.py .................                         [ 58%]
tests/test_orchestrator.py ............................................. [ 61%]
..........                                                               [ 62%]
tests/test_orchestrator_components_coverage.py F...                      [ 62%]
tests/test_orchestrator_coverage.py F.....                               [ 63%]
tests/test_orchestrator_coverage_final.py EEE                            [ 63%]
tests/test_orchestrator_extended.py ......                               [ 64%]
tests/test_pageindex.py ..................                               [ 65%]
tests/test_permissions.py ........                                       [ 66%]
tests/test_projects_secrets.py ........                                  [ 66%]
tests/test_push_notification_adapter.py ................................ [ 69%]
...................................                                      [ 72%]
tests/test_signal_adapter.py ........................................... [ 75%]
.....................                                                    [ 77%]
tests/test_slack_adapter.py ............................................ [ 80%]
................                                                         [ 82%]
tests/test_telegram_adapter.py ......................................... [ 85%]
....                                                                     [ 85%]
tests/test_tirith_guard.py .....................                         [ 87%]
tests/test_unified_gateway.py .......................................... [ 90%]
........................                                                 [ 92%]
tests/test_unified_gateway_thorough.py ...................               [ 94%]
tests/test_user_identity.py ..................                           [ 95%]
tests/test_v1_advanced.py ...                                            [ 95%]
tests/test_voice_adapter.py ...........                                  [ 96%]
tests/test_whatsapp_coverage.py ........F.FF.....                        [ 98%]
tests/test_whatsapp_coverage_2.py .FFF.F.F                               [ 98%]
tests/test_whatsapp_coverage_3.py F                                      [ 98%]
tests/test_whatsapp_coverage_4.py .....                                  [ 99%]
tests/test_whatsapp_coverage_final.py ....                               [ 99%]
tests/test_whatsapp_final.py .......                                     [100%]

==================================== ERRORS ====================================
__________ ERROR at setup of test_orchestrator_send_platform_message ___________

    @pytest.fixture
    def orchestrator():
        config = MagicMock()
        config.system.name = "TestBot"
        config.system.default_mode = "plan"
        config.paths = {"external_repos": "/tmp"}
        config.adapters = {}
    
        with (
            patch("core.orchestrator.MemoryServer"),
            patch("core.orchestrator.get_llm_provider"),
            patch("core.orchestrator.ModuleDiscovery"),
            patch("core.orchestrator.LokiMode"),
        ):
>           orch = MegaBotOrchestrator(config)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_orchestrator_coverage_final.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <core.orchestrator.MegaBotOrchestrator object at 0x753b364e6ae0>
config = <MagicMock id='128897173319184'>

    def __init__(self, config):
        """Initialize the MegaBot orchestrator with configuration.
    
        Args:
            config: Application configuration object containing adapter configs,
                   security policies, and system settings.
        """
        self.config = config
    
        # Register core services with DI container
        register_service(Config, config)
        register_singleton(MemoryServer, MemoryServer())
        register_factory(ComputerDriver, lambda: ComputerDriver())
    
        # Get project path safely - use config directly
        project_path = self.config.paths.get("workspaces", os.getcwd())
    
        register_factory(
            ProjectManager,
            lambda: ProjectManager(self.config.paths.get("workspaces", os.getcwd())),
        )
        register_factory(SecretManager, lambda: SecretManager())
        register_factory(
            PageIndexRAG,
            lambda: PageIndexRAG(
                project_path,
                llm=resolve_service(LLMProvider),
            ),
        )
    
        # Resolve services
        self.discovery = ModuleDiscovery(self.config.paths["external_repos"])
        self.mode = self.config.system.default_mode
    
        # Initialize LLM Provider
        llm_config = self.config.adapters.get("llm", {})
        if isinstance(llm_config, AdapterConfig):
            llm_config = llm_config.model_dump()
        self.llm = get_llm_provider(llm_config)
        register_singleton(LLMProvider, self.llm)
    
        # Initialize component handlers
        self.message_handler = MessageHandler(self)
        self.admin_handler = AdminHandler(self)
        self.health_monitor = HealthMonitor(self)
        self.background_tasks = BackgroundTasks(self)
    
        # Resolve other services
        self.computer_driver = resolve_service(ComputerDriver)
        self.project_manager = resolve_service(ProjectManager)
        self.project_manager.switch_project("default")
        self.secret_manager = resolve_service(SecretManager)
        self.rag = resolve_service(PageIndexRAG)
        self.permissions = PermissionManager(
            default_level=getattr(self.config.system, "default_permission", "ASK_EACH")
        )
        self.permissions.load_from_config(self.config.model_dump())
        self.memory = resolve_service(MemoryServer)
        self.sub_agents = {}  # Track active sub-agents
        self.last_active_chat = (
            None  # Track last messaging context for cross-platform sync
        )
        self.loki = LokiMode(self)
        self.clients = set()  # Track WebSocket clients
    
        # Initialize High-Level Features
        from features.dash_data.agent import DashDataAgent
    
        self.features = {"dash_data": DashDataAgent(self.llm, self)}
    
        self.adapters = {
            "openclaw": OpenClawAdapter(
>               self.config.adapters["openclaw"].host,
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                self.config.adapters["openclaw"].port,
            ),
            "memu": MemUAdapter(
                self.config.paths["external_repos"] + "/memU",
                self.config.adapters["memu"].database_url,
            ),
            "mcp": MCPManager(
                self.config.adapters["mcp"].servers
                if "mcp" in self.config.adapters
                else []
            ),
            "messaging": MegaBotMessagingServer(
                host="127.0.0.1", port=18790, enable_encryption=True
            ),
            "gateway": UnifiedGateway(
                megabot_server_port=18790,
                enable_cloudflare=True,
                enable_vpn=True,
                on_message=self.on_gateway_message,
            ),
        }
E       KeyError: 'openclaw'

core/orchestrator.py:214: KeyError
_____________ ERROR at setup of test_orchestrator_spawn_sub_agent ______________

    @pytest.fixture
    def orchestrator():
        config = MagicMock()
        config.system.name = "TestBot"
        config.system.default_mode = "plan"
        config.paths = {"external_repos": "/tmp"}
        config.adapters = {}
    
        with (
            patch("core.orchestrator.MemoryServer"),
            patch("core.orchestrator.get_llm_provider"),
            patch("core.orchestrator.ModuleDiscovery"),
            patch("core.orchestrator.LokiMode"),
        ):
>           orch = MegaBotOrchestrator(config)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_orchestrator_coverage_final.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <core.orchestrator.MegaBotOrchestrator object at 0x753b36335280>
config = <MagicMock id='128897172869232'>

    def __init__(self, config):
        """Initialize the MegaBot orchestrator with configuration.
    
        Args:
            config: Application configuration object containing adapter configs,
                   security policies, and system settings.
        """
        self.config = config
    
        # Register core services with DI container
        register_service(Config, config)
        register_singleton(MemoryServer, MemoryServer())
        register_factory(ComputerDriver, lambda: ComputerDriver())
    
        # Get project path safely - use config directly
        project_path = self.config.paths.get("workspaces", os.getcwd())
    
        register_factory(
            ProjectManager,
            lambda: ProjectManager(self.config.paths.get("workspaces", os.getcwd())),
        )
        register_factory(SecretManager, lambda: SecretManager())
        register_factory(
            PageIndexRAG,
            lambda: PageIndexRAG(
                project_path,
                llm=resolve_service(LLMProvider),
            ),
        )
    
        # Resolve services
        self.discovery = ModuleDiscovery(self.config.paths["external_repos"])
        self.mode = self.config.system.default_mode
    
        # Initialize LLM Provider
        llm_config = self.config.adapters.get("llm", {})
        if isinstance(llm_config, AdapterConfig):
            llm_config = llm_config.model_dump()
        self.llm = get_llm_provider(llm_config)
        register_singleton(LLMProvider, self.llm)
    
        # Initialize component handlers
        self.message_handler = MessageHandler(self)
        self.admin_handler = AdminHandler(self)
        self.health_monitor = HealthMonitor(self)
        self.background_tasks = BackgroundTasks(self)
    
        # Resolve other services
        self.computer_driver = resolve_service(ComputerDriver)
        self.project_manager = resolve_service(ProjectManager)
        self.project_manager.switch_project("default")
        self.secret_manager = resolve_service(SecretManager)
        self.rag = resolve_service(PageIndexRAG)
        self.permissions = PermissionManager(
            default_level=getattr(self.config.system, "default_permission", "ASK_EACH")
        )
        self.permissions.load_from_config(self.config.model_dump())
        self.memory = resolve_service(MemoryServer)
        self.sub_agents = {}  # Track active sub-agents
        self.last_active_chat = (
            None  # Track last messaging context for cross-platform sync
        )
        self.loki = LokiMode(self)
        self.clients = set()  # Track WebSocket clients
    
        # Initialize High-Level Features
        from features.dash_data.agent import DashDataAgent
    
        self.features = {"dash_data": DashDataAgent(self.llm, self)}
    
        self.adapters = {
            "openclaw": OpenClawAdapter(
>               self.config.adapters["openclaw"].host,
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                self.config.adapters["openclaw"].port,
            ),
            "memu": MemUAdapter(
                self.config.paths["external_repos"] + "/memU",
                self.config.adapters["memu"].database_url,
            ),
            "mcp": MCPManager(
                self.config.adapters["mcp"].servers
                if "mcp" in self.config.adapters
                else []
            ),
            "messaging": MegaBotMessagingServer(
                host="127.0.0.1", port=18790, enable_encryption=True
            ),
            "gateway": UnifiedGateway(
                megabot_server_port=18790,
                enable_cloudflare=True,
                enable_vpn=True,
                on_message=self.on_gateway_message,
            ),
        }
E       KeyError: 'openclaw'

core/orchestrator.py:214: KeyError
______ ERROR at setup of test_orchestrator_handle_tool_call_for_computer _______

    @pytest.fixture
    def orchestrator():
        config = MagicMock()
        config.system.name = "TestBot"
        config.system.default_mode = "plan"
        config.paths = {"external_repos": "/tmp"}
        config.adapters = {}
    
        with (
            patch("core.orchestrator.MemoryServer"),
            patch("core.orchestrator.get_llm_provider"),
            patch("core.orchestrator.ModuleDiscovery"),
            patch("core.orchestrator.LokiMode"),
        ):
>           orch = MegaBotOrchestrator(config)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_orchestrator_coverage_final.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <core.orchestrator.MegaBotOrchestrator object at 0x753b362d55b0>
config = <MagicMock id='128897170594736'>

    def __init__(self, config):
        """Initialize the MegaBot orchestrator with configuration.
    
        Args:
            config: Application configuration object containing adapter configs,
                   security policies, and system settings.
        """
        self.config = config
    
        # Register core services with DI container
        register_service(Config, config)
        register_singleton(MemoryServer, MemoryServer())
        register_factory(ComputerDriver, lambda: ComputerDriver())
    
        # Get project path safely - use config directly
        project_path = self.config.paths.get("workspaces", os.getcwd())
    
        register_factory(
            ProjectManager,
            lambda: ProjectManager(self.config.paths.get("workspaces", os.getcwd())),
        )
        register_factory(SecretManager, lambda: SecretManager())
        register_factory(
            PageIndexRAG,
            lambda: PageIndexRAG(
                project_path,
                llm=resolve_service(LLMProvider),
            ),
        )
    
        # Resolve services
        self.discovery = ModuleDiscovery(self.config.paths["external_repos"])
        self.mode = self.config.system.default_mode
    
        # Initialize LLM Provider
        llm_config = self.config.adapters.get("llm", {})
        if isinstance(llm_config, AdapterConfig):
            llm_config = llm_config.model_dump()
        self.llm = get_llm_provider(llm_config)
        register_singleton(LLMProvider, self.llm)
    
        # Initialize component handlers
        self.message_handler = MessageHandler(self)
        self.admin_handler = AdminHandler(self)
        self.health_monitor = HealthMonitor(self)
        self.background_tasks = BackgroundTasks(self)
    
        # Resolve other services
        self.computer_driver = resolve_service(ComputerDriver)
        self.project_manager = resolve_service(ProjectManager)
        self.project_manager.switch_project("default")
        self.secret_manager = resolve_service(SecretManager)
        self.rag = resolve_service(PageIndexRAG)
        self.permissions = PermissionManager(
            default_level=getattr(self.config.system, "default_permission", "ASK_EACH")
        )
        self.permissions.load_from_config(self.config.model_dump())
        self.memory = resolve_service(MemoryServer)
        self.sub_agents = {}  # Track active sub-agents
        self.last_active_chat = (
            None  # Track last messaging context for cross-platform sync
        )
        self.loki = LokiMode(self)
        self.clients = set()  # Track WebSocket clients
    
        # Initialize High-Level Features
        from features.dash_data.agent import DashDataAgent
    
        self.features = {"dash_data": DashDataAgent(self.llm, self)}
    
        self.adapters = {
            "openclaw": OpenClawAdapter(
>               self.config.adapters["openclaw"].host,
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                self.config.adapters["openclaw"].port,
            ),
            "memu": MemUAdapter(
                self.config.paths["external_repos"] + "/memU",
                self.config.adapters["memu"].database_url,
            ),
            "mcp": MCPManager(
                self.config.adapters["mcp"].servers
                if "mcp" in self.config.adapters
                else []
            ),
            "messaging": MegaBotMessagingServer(
                host="127.0.0.1", port=18790, enable_encryption=True
            ),
            "gateway": UnifiedGateway(
                megabot_server_port=18790,
                enable_cloudflare=True,
                enable_vpn=True,
                on_message=self.on_gateway_message,
            ),
        }
E       KeyError: 'openclaw'

core/orchestrator.py:214: KeyError
=================================== FAILURES ===================================
__________________________ test_message_handler_full ___________________________

mock_orchestrator = <MagicMock id='128897174490144'>

    @pytest.mark.asyncio
    async def test_message_handler_full(mock_orchestrator):
        handler = MessageHandler(mock_orchestrator)
        mock_orchestrator.memory.get_unified_id.return_value = "u1"
        mock_orchestrator.memory.chat_read.return_value = []
    
        # process_gateway_message
        await handler.process_gateway_message(
            {"type": "message", "content": "hi", "sender_id": "s1"}
        )
        assert mock_orchestrator.memory.chat_write.called
    
        # _process_attachments
        mock_driver = AsyncMock()
        mock_driver.execute.return_value = "cat"
        with patch(
            "core.orchestrator_components.resolve_service", return_value=mock_driver
        ):
            res = await handler._process_attachments(
                [{"type": "image", "data": "d"}], "s1", "c"
            )
>           assert "cat" in res
E           assert 'cat' in '\n[Attachment Analysis]: {"description": "A technical screenshot with potentially sensitive info.", "sensitive_region...th": 200, "height": 30, "label": "password"}, {"x": 400, "y": 250, "width": 150, "height": 20, "label": "api_key"}]}\n'

tests/test_orchestrator_components_coverage.py:50: AssertionError
----------------------------- Captured stdout call -----------------------------
Gateway Message: {'type': 'message', 'content': 'hi', 'sender_id': 's1'}
Vision-Agent: Analyzing attachment from s1...
_______________ test_orchestrator_initialization_all_components ________________

mock_config = Config(system=SystemConfig(name='TestBot', local_only=True, bind_address='127.0.0.1', telemetry=False, default_mode='p...ityConfig(megabot_backup_key=None, megabot_encryption_salt='test-salt-minimum-16-chars', megabot_media_path='./media'))

    @pytest.mark.asyncio
    async def test_orchestrator_initialization_all_components(mock_config):
        async def mock_coro():
            pass
    
        with (
            patch("core.orchestrator.MemoryServer"),
            patch("core.orchestrator.OpenClawAdapter") as mock_oc,
            patch("core.orchestrator.MemUAdapter"),
            patch("core.orchestrator.MCPManager") as mock_mcp,
            patch("core.orchestrator.MegaBotMessagingServer") as mock_msg,
            patch("core.orchestrator.UnifiedGateway") as mock_gw,
            patch("core.orchestrator.ModuleDiscovery"),
            patch("core.orchestrator.LokiMode"),
            patch("core.orchestrator.get_llm_provider"),
        ):
            mock_msg.return_value.start = mock_coro
            mock_gw.return_value.start = mock_coro
            mock_oc.return_value.connect = AsyncMock()
            mock_oc.return_value.subscribe_events = AsyncMock()
            mock_mcp.return_value.start_all = AsyncMock()
    
            orch = MegaBotOrchestrator(mock_config)
            orch.background_tasks = AsyncMock()
            orch.rag = AsyncMock()
    
            await orch.start()
>           assert orch.discovery.scan.called
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'function' object has no attribute 'called'

tests/test_orchestrator_coverage.py:53: AttributeError
----------------------------- Captured stdout call -----------------------------
WARNING: memU not found at /tmp/memU. Using functional fallback mock.
Starting TestBot in plan mode...
Scanning for capabilities in /tmp...
Found capability: megabot_media_test at /tmp/megabot_media_test
Found capability: backups at /tmp/backups
Found capability: .X11-unix at /tmp/.X11-unix
Found capability: __pycache__ at /tmp/__pycache__
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-resolved.service-XxcHyQ at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-resolved.service-XxcHyQ
Found capability: pyright-3010-euC3iie8ppyS at /tmp/pyright-3010-euC3iie8ppyS
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-timesyncd.service-yU9Pa8 at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-timesyncd.service-yU9Pa8
Found capability: pytest-of-rhushabh at /tmp/pytest-of-rhushabh
Found capability: Nexus at /tmp/Nexus
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-polkit.service-G7Bhkk at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-polkit.service-G7Bhkk
Found capability: projects at /tmp/projects
Found capability: custom_backups at /tmp/custom_backups
Found capability: pyright-1439-kxOTPC0NgtAT at /tmp/pyright-1439-kxOTPC0NgtAT
Found capability: snap-private-tmp at /tmp/snap-private-tmp
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-wsl-pro.service-X9CKLH at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-wsl-pro.service-X9CKLH
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-logind.service-80A1In at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-logind.service-80A1In
Starting Messaging Server on ws://127.0.0.1:18790
Failed to connect to OpenClaw: [Errno 111] Connect call failed ('127.0.0.1', 8080)
MCP Servers started.
Project RAG index built for: <AsyncMock name='mock.root_dir' id='128897173178224'>
________________________ test_whatsapp_send_text_direct ________________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b3c1d8200>

    @pytest.mark.asyncio
    async def test_whatsapp_send_text_direct(adapter):
        adapter.is_initialized = True
        adapter.session = AsyncMock()
        mock_resp = AsyncMock()
        mock_resp.status = 200
        mock_resp.json.return_value = {"messages": [{"id": "wa123"}]}
        mock_resp.__aenter__.return_value = mock_resp
        adapter.session.post.return_value = mock_resp
        msg = await adapter.send_text("chat1", "hello")
>       assert msg.id == "wa123"
               ^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'id'

tests/test_whatsapp_coverage.py:129: AttributeError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
_________________________ test_whatsapp_send_location __________________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b363eb590>

    @pytest.mark.asyncio
    async def test_whatsapp_send_location(adapter):
        adapter.is_initialized = True
        adapter.session = AsyncMock()
        mock_resp = AsyncMock()
        mock_resp.status = 200
        mock_resp.json.return_value = {"messages": [{"id": "loc123"}]}
        mock_resp.__aenter__.return_value = mock_resp
        adapter.session.post.return_value = mock_resp
        msg = await adapter.send_location("chat1", 1.0, 2.0, address="Addr", name="Place")
>       assert msg.id == "loc123"
               ^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'id'

tests/test_whatsapp_coverage.py:151: AttributeError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
__________________________ test_whatsapp_send_contact __________________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b3649da30>

    @pytest.mark.asyncio
    async def test_whatsapp_send_contact(adapter):
        adapter.is_initialized = True
        adapter.session = AsyncMock()
        mock_resp = AsyncMock()
        mock_resp.status = 200
        mock_resp.json.return_value = {"messages": [{"id": "con123"}]}
        mock_resp.__aenter__.return_value = mock_resp
        adapter.session.post.return_value = mock_resp
        msg = await adapter.send_contact("chat1", {"name": "John", "phone": "123"})
>       assert msg.id == "con123"
               ^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'id'

tests/test_whatsapp_coverage.py:169: AttributeError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
________________________ test_whatsapp_send_text_direct ________________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b362d60c0>

    @pytest.mark.asyncio
    async def test_whatsapp_send_text_direct(adapter):
        adapter.session = AsyncMock()
        mock_resp = AsyncMock()
        mock_resp.status = 200
        mock_resp.json.return_value = {"messages": [{"id": "real_wa_id"}]}
        mock_resp.__aenter__.return_value = mock_resp
        adapter.session.post.return_value = mock_resp
    
        msg = await adapter.send_text("chat1", "hello")
>       assert msg.id == "real_wa_id"
               ^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'id'

tests/test_whatsapp_coverage_2.py:53: AttributeError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
_________________________ test_whatsapp_send_location __________________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b36399bb0>

    @pytest.mark.asyncio
    async def test_whatsapp_send_location(adapter):
        adapter.session = AsyncMock()
        mock_resp = AsyncMock()
        mock_resp.status = 200
        mock_resp.json.return_value = {"messages": [{"id": "loc_id"}]}
        mock_resp.__aenter__.return_value = mock_resp
        adapter.session.post.return_value = mock_resp
    
        msg = await adapter.send_location("chat1", 1.0, 2.0)
>       assert msg.id == "loc_id"
               ^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'id'

tests/test_whatsapp_coverage_2.py:66: AttributeError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
__________________________ test_whatsapp_send_contact __________________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b364c50d0>

    @pytest.mark.asyncio
    async def test_whatsapp_send_contact(adapter):
        adapter.session = AsyncMock()
        mock_resp = AsyncMock()
        mock_resp.status = 200
        mock_resp.json.return_value = {"messages": [{"id": "con_id"}]}
        mock_resp.__aenter__.return_value = mock_resp
        adapter.session.post.return_value = mock_resp
    
        msg = await adapter.send_contact("chat1", {"name": "J", "phone": "1"})
>       assert msg.id == "con_id"
               ^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'id'

tests/test_whatsapp_coverage_2.py:79: AttributeError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
_____________________ test_whatsapp_upload_media_hang_fix ______________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b364c75c0>

    @pytest.mark.asyncio
    async def test_whatsapp_upload_media_hang_fix(adapter):
        adapter.session = AsyncMock()
        mock_resp = AsyncMock()
        mock_resp.status = 200
        mock_resp.json.return_value = {"id": "up_id"}
        mock_resp.__aenter__.return_value = mock_resp
        adapter.session.post.return_value = mock_resp
    
        with patch("os.path.exists", return_value=True):
            with patch("builtins.open", return_value=io.BytesIO(b"abc")):
                res = await adapter._upload_media("file.png", MessageType.IMAGE)
>               assert res == "up_id"
E               AssertionError: assert None == 'up_id'

tests/test_whatsapp_coverage_2.py:137: AssertionError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Media upload error: 'coroutine' object does not support the asynchronous context manager protocol
_____________________ test_whatsapp_send_with_retry_logic ______________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b362d60f0>

    @pytest.mark.asyncio
    async def test_whatsapp_send_with_retry_logic(adapter):
        adapter.session = AsyncMock()
        mock_resp_fail = AsyncMock()
        mock_resp_fail.status = 500
        mock_resp_fail.__aenter__.return_value = mock_resp_fail
    
        mock_resp_ok = AsyncMock()
        mock_resp_ok.status = 200
        mock_resp_ok.json.return_value = {"ok": True}
        mock_resp_ok.__aenter__.return_value = mock_resp_ok
    
        adapter.session.post.side_effect = [mock_resp_fail, mock_resp_ok]
    
        with patch("asyncio.sleep", return_value=None):
            res = await adapter._send_with_retry({"p": 1})
>           assert res == {"ok": True}
E           AssertionError: assert None == {'ok': True}

tests/test_whatsapp_coverage_2.py:163: AssertionError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
_______________________ test_whatsapp_remaining_branches _______________________

adapter = <adapters.messaging.whatsapp.WhatsAppAdapter object at 0x753b3cf943e0>

    @pytest.mark.asyncio
    async def test_whatsapp_remaining_branches(adapter):
        # send_location openclaw fail
        adapter._use_openclaw = True
        adapter._openclaw = AsyncMock()
        adapter._openclaw.execute_tool.return_value = {"error": "fail"}
        res = await adapter.send_location("c1", 0, 0)
        assert res.id.startswith("wa_")
    
        # send_contact direct fail
        adapter._use_openclaw = False
        adapter.session.post.return_value.__aenter__.return_value.status = 400
        with patch("asyncio.sleep", return_value=None):
            res = await adapter.send_contact("c1", {"name": "N"})
            assert res is None
    
        # handle_webhook various cases
        # 1. empty
        assert await adapter.handle_webhook({}) is None
        # 2. no messages
        assert (
            await adapter.handle_webhook({"entry": [{"changes": [{"value": {}}]}]}) is None
        )
        # 3. interactive button_reply
        data_btn = {
            "entry": [
                {
                    "changes": [
                        {
                            "value": {
                                "messages": [
                                    {
                                        "from": "u1",
                                        "id": "m1",
                                        "type": "interactive",
                                        "interactive": {
                                            "type": "button_reply",
                                            "button_reply": {"title": "Yes", "id": "y1"},
                                        },
                                    }
                                ]
                            }
                        }
                    ]
                }
            ]
        }
        msg = await adapter.handle_webhook(data_btn)
>       assert msg.content == "Yes"
               ^^^^^^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'content'

tests/test_whatsapp_coverage_3.py:78: AttributeError
----------------------------- Captured stdout call -----------------------------
[WhatsApp] API error 400: <AsyncMock name='mock.post().__aenter__().text()' id='128897176890704'>
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.6-final-0 ________________

Name                                    Stmts   Miss  Cover   Missing
---------------------------------------------------------------------
adapters/__init__.py                        3      0   100%
adapters/channels/__init__.py               0      0   100%
adapters/discord_adapter.py               347      4    99%   35, 38, 42, 775
adapters/mcp_adapter.py                    58      9    84%   30, 63-66, 72, 76-79
adapters/memu_adapter.py                  102      6    94%   108-115
adapters/messaging/__init__.py             15      0   100%
adapters/messaging/__main__.py              2      0   100%
adapters/messaging/imessage.py             29      0   100%
adapters/messaging/server.py              265      0   100%
adapters/messaging/sms.py                  35      0   100%
adapters/messaging/telegram.py            103      0   100%
adapters/messaging/whatsapp.py            427     44    90%   45-47, 88-89, 202, 341-357, 394-399, 408-410, 425-444, 467-493, 648-649, 655-659, 661-662, 741, 769, 784, 820, 852-856
adapters/nanobot_adapter.py                74      4    95%   41-43, 120
adapters/openclaw_adapter.py               73      4    95%   20-23
adapters/push_notification_adapter.py     494      8    98%   729, 1029, 1032, 1066, 1082, 1100, 1146-1148
adapters/security/__init__.py               2      0   100%
adapters/security/tirith_guard.py          31      1    97%   43
adapters/signal_adapter.py                486      0   100%
adapters/slack_adapter.py                 246      3    99%   27, 30, 34
adapters/telegram_adapter.py              653      2    99%   1234-1235
adapters/unified_gateway.py                 5      0   100%
adapters/voice_adapter.py                  71     14    80%   15-28, 95-96, 130-131
core/__init__.py                            5      0   100%
core/admin_handler.py                     200     15    92%   108, 123, 170, 278, 318-339, 394
core/agents.py                             47      2    96%   77-80
core/config.py                            143     14    90%   26-27, 71-82, 127, 129, 144, 194, 196, 252
core/dependencies.py                       87      6    93%   54, 85, 107-108, 122-123
core/discovery.py                          24      0   100%
core/drivers.py                            90      7    92%   25, 28, 31, 34, 37, 40-41
core/instrumentation.py                    38      3    92%   50, 57, 61
core/interfaces.py                         17      0   100%
core/llm_providers.py                     268      1    99%   19
core/loki.py                              131      4    97%   74, 288-289, 341
core/memory/__init__.py                     6      0   100%
core/memory/backup_manager.py             107      4    96%   104-106, 112
core/memory/chat_memory.py                 94      6    94%   186-188, 203-205
core/memory/knowledge_memory.py           127     21    83%   63-65, 86-88, 119-121, 175-177, 193-195, 213-215, 239-241
core/memory/mcp_server.py                  79      2    97%   45-46
core/memory/user_identity.py               68      0   100%
core/network/__init__.py                    0      0   100%
core/network/gateway.py                   332     34    90%   103-121, 142-143, 149-151, 417-431
core/network/monitor.py                    22      1    95%   15
core/network/server.py                     22      0   100%
core/network/tunnel.py                     38      0   100%
core/orchestrator.py                      914    261    71%   353, 357-365, 368-382, 385-393, 396-404, 408-429, 432-440, 443-460, 489, 537-538, 598-599, 614-615, 620, 627, 649-650, 662-663, 766-778, 789-790, 793-827, 835, 848-851, 873, 886-906, 919-922, 926-928, 932-990, 1111-1112, 1189-1275, 1329, 1370-1386, 1397, 1402-1404, 1412, 1422, 1429, 1437-1467, 1477-1501, 1530, 1535, 1537, 1648, 1677-1694, 1697-1720, 1723-1755, 1758-1770, 1777, 1911-1914, 1928-1931, 1947-1950
core/orchestrator_components.py           185     25    86%   119-125, 176-177, 185-186, 225, 256-257, 265-266, 273-274, 278, 308-312, 324-325, 335-336
core/permissions.py                        52      4    92%   35-36, 101-102
core/projects.py                           38      3    92%   26, 31, 53
core/rag/__init__.py                        2      0   100%
core/rag/pageindex.py                     112      8    93%   28-29, 42-43, 77-78, 110, 165
core/secrets.py                            36      5    86%   24-28
---------------------------------------------------------------------
TOTAL                                    6805    525    92%
=========================== short test summary info ============================
FAILED tests/test_orchestrator_components_coverage.py::test_message_handler_full
FAILED tests/test_orchestrator_coverage.py::test_orchestrator_initialization_all_components
FAILED tests/test_whatsapp_coverage.py::test_whatsapp_send_text_direct - Attr...
FAILED tests/test_whatsapp_coverage.py::test_whatsapp_send_location - Attribu...
FAILED tests/test_whatsapp_coverage.py::test_whatsapp_send_contact - Attribut...
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_text_direct - At...
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_location - Attri...
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_contact - Attrib...
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_upload_media_hang_fix
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_with_retry_logic
FAILED tests/test_whatsapp_coverage_3.py::test_whatsapp_remaining_branches - ...
ERROR tests/test_orchestrator_coverage_final.py::test_orchestrator_send_platform_message
ERROR tests/test_orchestrator_coverage_final.py::test_orchestrator_spawn_sub_agent
ERROR tests/test_orchestrator_coverage_final.py::test_orchestrator_handle_tool_call_for_computer
============= 11 failed, 1236 passed, 3 errors in 80.60s (0:01:20) =============
