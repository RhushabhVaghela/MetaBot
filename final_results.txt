============================= test session starts ==============================
platform linux -- Python 3.12.6, pytest-9.0.2, pluggy-1.6.0
rootdir: /mnt/d/MegaBot
configfile: pyproject.toml
plugins: asyncio-1.3.0, cov-7.0.0, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1251 items

tests/test_admin_handler.py ......................................       [  3%]
tests/test_agents.py ........                                            [  3%]
tests/test_backup_manager.py .................                           [  5%]
tests/test_chat_memory.py .................                              [  6%]
tests/test_config.py .....                                               [  6%]
tests/test_coverage_completion.py .....                                  [  7%]
tests/test_coverage_completion_final.py ...................              [  8%]
tests/test_coverage_gaps.py .............                                [  9%]
tests/test_dependencies_full.py ..........                               [ 10%]
tests/test_discord_adapter.py .......................................... [ 13%]
......................................................                   [ 18%]
tests/test_discovery.py ..                                               [ 18%]
tests/test_drivers.py ...................                                [ 19%]
tests/test_extra_llm_providers.py ....                                   [ 20%]
tests/test_fastapi_endpoints.py ....                                     [ 20%]
tests/test_instrumentation_discovery.py .....                            [ 20%]
tests/test_integration_adapters.py .....                                 [ 21%]
tests/test_interfaces.py ..                                              [ 21%]
tests/test_knowledge_memory.py ....................                      [ 23%]
tests/test_llm_providers.py ........................                     [ 25%]
tests/test_llm_providers_coverage.py .........                           [ 25%]
tests/test_llm_providers_new.py ......                                   [ 26%]
tests/test_loki.py ..................                                    [ 27%]
tests/test_main.py .                                                     [ 27%]
tests/test_mcp_adapter.py ......                                         [ 28%]
tests/test_mcp_server.py ..........................                      [ 30%]
tests/test_megabot_messaging.py ........................................ [ 33%]
........................................................................ [ 39%]
.........................................................                [ 43%]
tests/test_memory_logic.py .                                             [ 43%]
tests/test_memu_adapter.py .................                             [ 45%]
tests/test_messaging_imessage.py .....                                   [ 45%]
tests/test_messaging_server.py ..........................                [ 47%]
tests/test_messaging_server_coverage.py .................                [ 49%]
tests/test_messaging_sms.py .......                                      [ 49%]
tests/test_messaging_telegram.py ....................................... [ 52%]
....                                                                     [ 53%]
tests/test_minimal.py .                                                  [ 53%]
tests/test_nanobot_adapter.py ...........                                [ 54%]
tests/test_network_monitor.py ............                               [ 54%]
tests/test_network_server.py ........                                    [ 55%]
tests/test_network_tunnel.py ..............                              [ 56%]
tests/test_openclaw_adapter.py .................                         [ 58%]
tests/test_orchestrator.py ............................................. [ 61%]
..........                                                               [ 62%]
tests/test_orchestrator_components_coverage.py F...                      [ 62%]
tests/test_orchestrator_coverage.py F.....                               [ 63%]
tests/test_orchestrator_coverage_final.py EEE                            [ 63%]
tests/test_orchestrator_extended.py ......                               [ 64%]
tests/test_pageindex.py ..................                               [ 65%]
tests/test_permissions.py ........                                       [ 66%]
tests/test_projects_secrets.py ........                                  [ 66%]
tests/test_push_notification_adapter.py ................................ [ 69%]
...................................                                      [ 72%]
tests/test_signal_adapter.py ........................................... [ 75%]
.....................                                                    [ 77%]
tests/test_slack_adapter.py ............................................ [ 80%]
................                                                         [ 82%]
tests/test_telegram_adapter.py ......................................... [ 85%]
....                                                                     [ 85%]
tests/test_tirith_guard.py .....................                         [ 87%]
tests/test_unified_gateway.py .......................................... [ 90%]
........................                                                 [ 92%]
tests/test_unified_gateway_thorough.py ...................               [ 94%]
tests/test_user_identity.py ..................                           [ 95%]
tests/test_v1_advanced.py ...                                            [ 95%]
tests/test_voice_adapter.py ...........                                  [ 96%]
tests/test_whatsapp_coverage.py .................                        [ 98%]
tests/test_whatsapp_coverage_2.py .FFF.F.F                               [ 98%]
tests/test_whatsapp_coverage_3.py F                                      [ 98%]
tests/test_whatsapp_coverage_4.py .....                                  [ 99%]
tests/test_whatsapp_coverage_final.py ....                               [ 99%]
tests/test_whatsapp_final.py .......                                     [100%]

==================================== ERRORS ====================================
__________ ERROR at setup of test_orchestrator_send_platform_message ___________
tests/test_orchestrator_coverage_final.py:23: in orchestrator
    orch = MegaBotOrchestrator(config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
core/orchestrator.py:214: in __init__
    self.config.adapters["openclaw"].host,
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'openclaw'
_____________ ERROR at setup of test_orchestrator_spawn_sub_agent ______________
tests/test_orchestrator_coverage_final.py:23: in orchestrator
    orch = MegaBotOrchestrator(config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
core/orchestrator.py:214: in __init__
    self.config.adapters["openclaw"].host,
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'openclaw'
______ ERROR at setup of test_orchestrator_handle_tool_call_for_computer _______
tests/test_orchestrator_coverage_final.py:23: in orchestrator
    orch = MegaBotOrchestrator(config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
core/orchestrator.py:214: in __init__
    self.config.adapters["openclaw"].host,
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'openclaw'
=================================== FAILURES ===================================
__________________________ test_message_handler_full ___________________________
tests/test_orchestrator_components_coverage.py:50: in test_message_handler_full
    assert "cat" in res
E   assert 'cat' in '\n[Attachment Analysis]: {"description": "A technical screenshot with potentially sensitive info.", "sensitive_region...th": 200, "height": 30, "label": "password"}, {"x": 400, "y": 250, "width": 150, "height": 20, "label": "api_key"}]}\n'
----------------------------- Captured stdout call -----------------------------
Gateway Message: {'type': 'message', 'content': 'hi', 'sender_id': 's1'}
Vision-Agent: Analyzing attachment from s1...
_______________ test_orchestrator_initialization_all_components ________________
tests/test_orchestrator_coverage.py:53: in test_orchestrator_initialization_all_components
    assert orch.discovery.scan.called
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'function' object has no attribute 'called'
----------------------------- Captured stdout call -----------------------------
WARNING: memU not found at /tmp/memU. Using functional fallback mock.
Starting TestBot in plan mode...
Scanning for capabilities in /tmp...
Found capability: megabot_media_test at /tmp/megabot_media_test
Found capability: backups at /tmp/backups
Found capability: .X11-unix at /tmp/.X11-unix
Found capability: __pycache__ at /tmp/__pycache__
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-resolved.service-XxcHyQ at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-resolved.service-XxcHyQ
Found capability: pyright-3010-euC3iie8ppyS at /tmp/pyright-3010-euC3iie8ppyS
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-timesyncd.service-yU9Pa8 at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-timesyncd.service-yU9Pa8
Found capability: pytest-of-rhushabh at /tmp/pytest-of-rhushabh
Found capability: cline at /tmp/cline
Found capability: pyright-54056-2mc6Ub78jA0E at /tmp/pyright-54056-2mc6Ub78jA0E
Found capability: Nexus at /tmp/Nexus
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-polkit.service-G7Bhkk at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-polkit.service-G7Bhkk
Found capability: projects at /tmp/projects
Found capability: custom_backups at /tmp/custom_backups
Found capability: gemini at /tmp/gemini
Found capability: pyright-1439-kxOTPC0NgtAT at /tmp/pyright-1439-kxOTPC0NgtAT
Found capability: snap-private-tmp at /tmp/snap-private-tmp
Found capability: systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-logind.service-80A1In at /tmp/systemd-private-907f8c4cfbde48a7b27bdee84cdde2a0-systemd-logind.service-80A1In
Starting Messaging Server on ws://127.0.0.1:18790
Failed to connect to OpenClaw: [Errno 111] Connect call failed ('127.0.0.1', 8080)
MCP Servers started.
Project RAG index built for: <AsyncMock name='mock.root_dir' id='135393877000464'>
________________________ test_whatsapp_send_text_direct ________________________
tests/test_whatsapp_coverage_2.py:53: in test_whatsapp_send_text_direct
    assert msg.id == "real_wa_id"
           ^^^^^^
E   AttributeError: 'NoneType' object has no attribute 'id'
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
_________________________ test_whatsapp_send_location __________________________
tests/test_whatsapp_coverage_2.py:66: in test_whatsapp_send_location
    assert msg.id == "loc_id"
           ^^^^^^
E   AttributeError: 'NoneType' object has no attribute 'id'
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
__________________________ test_whatsapp_send_contact __________________________
tests/test_whatsapp_coverage_2.py:79: in test_whatsapp_send_contact
    assert msg.id == "con_id"
           ^^^^^^
E   AttributeError: 'NoneType' object has no attribute 'id'
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
_____________________ test_whatsapp_upload_media_hang_fix ______________________
tests/test_whatsapp_coverage_2.py:137: in test_whatsapp_upload_media_hang_fix
    assert res == "up_id"
E   AssertionError: assert None == 'up_id'
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Media upload error: 'coroutine' object does not support the asynchronous context manager protocol
_____________________ test_whatsapp_send_with_retry_logic ______________________
tests/test_whatsapp_coverage_2.py:163: in test_whatsapp_send_with_retry_logic
    assert res == {"ok": True}
E   AssertionError: assert None == {'ok': True}
----------------------------- Captured stdout call -----------------------------
[WhatsApp] Send failed after 3 attempts: 'coroutine' object does not support the asynchronous context manager protocol
_______________________ test_whatsapp_remaining_branches _______________________
tests/test_whatsapp_coverage_3.py:78: in test_whatsapp_remaining_branches
    assert msg.content == "Yes"
           ^^^^^^^^^^^
E   AttributeError: 'NoneType' object has no attribute 'content'
----------------------------- Captured stdout call -----------------------------
[WhatsApp] API error 400: <AsyncMock name='mock.post().__aenter__().text()' id='135394085796800'>
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.6-final-0 ________________

Name                                    Stmts   Miss  Cover   Missing
---------------------------------------------------------------------
adapters/__init__.py                        3      0   100%
adapters/channels/__init__.py               0      0   100%
adapters/discord_adapter.py               347      4    99%   35, 38, 42, 775
adapters/mcp_adapter.py                    58      9    84%   30, 63-66, 72, 76-79
adapters/memu_adapter.py                  102      6    94%   108-115
adapters/messaging/__init__.py             15      0   100%
adapters/messaging/__main__.py              2      0   100%
adapters/messaging/imessage.py             29      0   100%
adapters/messaging/server.py              265      0   100%
adapters/messaging/sms.py                  35      0   100%
adapters/messaging/telegram.py            103      0   100%
adapters/messaging/whatsapp.py            427     44    90%   45-47, 88-89, 202, 341-357, 394-399, 408-410, 425-444, 467-493, 648-649, 655-659, 661-662, 741, 769, 784, 820, 852-856
adapters/nanobot_adapter.py                74      4    95%   41-43, 120
adapters/openclaw_adapter.py               73      4    95%   20-23
adapters/push_notification_adapter.py     494      8    98%   729, 1029, 1032, 1066, 1082, 1100, 1146-1148
adapters/security/__init__.py               2      0   100%
adapters/security/tirith_guard.py          31      1    97%   43
adapters/signal_adapter.py                486      0   100%
adapters/slack_adapter.py                 246      3    99%   27, 30, 34
adapters/telegram_adapter.py              653      2    99%   1234-1235
adapters/unified_gateway.py                 5      0   100%
adapters/voice_adapter.py                  71     14    80%   15-28, 95-96, 130-131
core/__init__.py                            5      0   100%
core/admin_handler.py                     200     15    92%   108, 123, 170, 278, 318-339, 394
core/agents.py                             47      2    96%   77-80
core/config.py                            143     14    90%   26-27, 71-82, 127, 129, 144, 194, 196, 252
core/dependencies.py                       87      6    93%   54, 85, 107-108, 122-123
core/discovery.py                          24      0   100%
core/drivers.py                            90      7    92%   25, 28, 31, 34, 37, 40-41
core/instrumentation.py                    38      3    92%   50, 57, 61
core/interfaces.py                         17      0   100%
core/llm_providers.py                     268      1    99%   19
core/loki.py                              131      4    97%   74, 288-289, 341
core/memory/__init__.py                     6      0   100%
core/memory/backup_manager.py             107      4    96%   104-106, 112
core/memory/chat_memory.py                 94      6    94%   186-188, 203-205
core/memory/knowledge_memory.py           127     21    83%   63-65, 86-88, 119-121, 175-177, 193-195, 213-215, 239-241
core/memory/mcp_server.py                  79      2    97%   45-46
core/memory/user_identity.py               68      0   100%
core/network/__init__.py                    0      0   100%
core/network/gateway.py                   332     34    90%   103-121, 142-143, 149-151, 417-431
core/network/monitor.py                    22      1    95%   15
core/network/server.py                     22      0   100%
core/network/tunnel.py                     38      0   100%
core/orchestrator.py                      914    261    71%   353, 357-365, 368-382, 385-393, 396-404, 408-429, 432-440, 443-460, 489, 537-538, 598-599, 614-615, 620, 627, 649-650, 662-663, 766-778, 789-790, 793-827, 835, 848-851, 873, 886-906, 919-922, 926-928, 932-990, 1111-1112, 1189-1275, 1329, 1370-1386, 1397, 1402-1404, 1412, 1422, 1429, 1437-1467, 1477-1501, 1530, 1535, 1537, 1648, 1677-1694, 1697-1720, 1723-1755, 1758-1770, 1777, 1911-1914, 1928-1931, 1947-1950
core/orchestrator_components.py           185     25    86%   119-125, 176-177, 185-186, 225, 256-257, 265-266, 273-274, 278, 308-312, 324-325, 335-336
core/permissions.py                        52      4    92%   35-36, 101-102
core/projects.py                           38      3    92%   26, 31, 53
core/rag/__init__.py                        2      0   100%
core/rag/pageindex.py                     112      8    93%   28-29, 42-43, 77-78, 110, 165
core/secrets.py                            36      5    86%   24-28
---------------------------------------------------------------------
TOTAL                                    6805    525    92%
=========================== short test summary info ============================
FAILED tests/test_orchestrator_components_coverage.py::test_message_handler_full
FAILED tests/test_orchestrator_coverage.py::test_orchestrator_initialization_all_components
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_text_direct - At...
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_location - Attri...
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_contact - Attrib...
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_upload_media_hang_fix
FAILED tests/test_whatsapp_coverage_2.py::test_whatsapp_send_with_retry_logic
FAILED tests/test_whatsapp_coverage_3.py::test_whatsapp_remaining_branches - ...
ERROR tests/test_orchestrator_coverage_final.py::test_orchestrator_send_platform_message
ERROR tests/test_orchestrator_coverage_final.py::test_orchestrator_spawn_sub_agent
ERROR tests/test_orchestrator_coverage_final.py::test_orchestrator_handle_tool_call_for_computer
============= 8 failed, 1240 passed, 3 errors in 93.40s (0:01:33) ==============
