============================= test session starts ==============================
platform linux -- Python 3.12.6, pytest-9.0.2, pluggy-1.6.0
rootdir: /mnt/d/MegaBot
configfile: pyproject.toml
plugins: asyncio-1.3.0, cov-7.0.0, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1169 items

tests/test_admin_handler.py ......................................       [  3%]
tests/test_agents.py ........                                            [  3%]
tests/test_backup_manager.py .................                           [  5%]
tests/test_chat_memory.py .................                              [  6%]
tests/test_config.py .....                                               [  7%]
tests/test_coverage_completion.py .....                                  [  7%]
tests/test_coverage_completion_final.py ...............FF..              [  9%]
tests/test_coverage_gaps.py .............                                [ 10%]
tests/test_dependencies_full.py ..........                               [ 11%]
tests/test_discord_adapter.py .......................................... [ 14%]
......................................................                   [ 19%]
tests/test_discovery.py ..                                               [ 19%]
tests/test_drivers.py ...................                                [ 21%]
tests/test_extra_llm_providers.py ....                                   [ 21%]
tests/test_fastapi_endpoints.py ....                                     [ 21%]
tests/test_instrumentation_discovery.py .....                            [ 22%]
tests/test_integration_adapters.py .....                                 [ 22%]
tests/test_interfaces.py ..                                              [ 23%]
tests/test_knowledge_memory.py ....................                      [ 24%]
tests/test_llm_providers.py ........................                     [ 26%]
tests/test_llm_providers_new.py ......                                   [ 27%]
tests/test_loki.py ..................                                    [ 28%]
tests/test_main.py .                                                     [ 28%]
tests/test_mcp_adapter.py ......                                         [ 29%]
tests/test_mcp_server.py ..........................                      [ 31%]
tests/test_megabot_messaging.py ........................................ [ 35%]
........................................................................ [ 41%]
.........................................................                [ 46%]
tests/test_memory_logic.py .                                             [ 46%]
tests/test_memu_adapter.py .................                             [ 47%]
tests/test_messaging_imessage.py .....                                   [ 48%]
tests/test_messaging_server.py ..........................                [ 50%]
tests/test_messaging_sms.py .......                                      [ 50%]
tests/test_messaging_telegram.py ....................................... [ 54%]
....                                                                     [ 54%]
tests/test_nanobot_adapter.py ...........                                [ 55%]
tests/test_network_monitor.py ............                               [ 56%]
tests/test_network_server.py ........                                    [ 57%]
tests/test_network_tunnel.py ..............                              [ 58%]
tests/test_openclaw_adapter.py .................                         [ 59%]
tests/test_orchestrator.py ............................................. [ 63%]
..........                                                               [ 64%]
tests/test_orchestrator_extended.py ......                               [ 65%]
tests/test_pageindex.py ..................                               [ 66%]
tests/test_permissions.py ........                                       [ 67%]
tests/test_projects_secrets.py ........                                  [ 68%]
tests/test_push_notification_adapter.py ................................ [ 70%]
...................................                                      [ 73%]
tests/test_signal_adapter.py ........................................... [ 77%]
.....................                                                    [ 79%]
tests/test_slack_adapter.py ............................................ [ 82%]
................                                                         [ 84%]
tests/test_telegram_adapter.py ......................................... [ 87%]
....                                                                     [ 88%]
tests/test_tirith_guard.py .....................                         [ 89%]
tests/test_unified_gateway.py .......................................... [ 93%]
........................                                                 [ 95%]
tests/test_unified_gateway_thorough.py ...................               [ 97%]
tests/test_user_identity.py ..................                           [ 98%]
tests/test_v1_advanced.py ...                                            [ 99%]
tests/test_voice_adapter.py ...........                                  [100%]

=================================== FAILURES ===================================
______ TestOrchestratorCoverage.test_sanitize_output_with_various_inputs _______

self = <test_coverage_completion_final.TestOrchestratorCoverage object at 0x712fbded22d0>
orchestrator = <core.orchestrator.MegaBotOrchestrator object at 0x712fbb6f8b00>

    def test_sanitize_output_with_various_inputs(self, orchestrator):
>       assert orchestrator._sanitize_output(None) == ""
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_coverage_completion_final.py:292: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <core.orchestrator.MegaBotOrchestrator object at 0x712fbb6f8b00>
text = None

    def _sanitize_output(self, text: str) -> str:
        """Strip ANSI escape sequences and other potentially dangerous terminal characters"""
        # Remove ANSI escape sequences
        ansi_escape = re.compile(r"\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])")
>       sanitized = ansi_escape.sub("", text)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: expected string or bytes-like object, got 'NoneType'

core/orchestrator.py:1615: TypeError
---------------------------- Captured stdout setup -----------------------------
WARNING: memU not found at /tmp/mock_repos/memU. Using functional fallback mock.
___________ TestOrchestratorCoverage.test_check_identity_claims_none ___________

self = <test_coverage_completion_final.TestOrchestratorCoverage object at 0x712fbded1d60>
orchestrator = <core.orchestrator.MegaBotOrchestrator object at 0x712fbb71bec0>

    @pytest.mark.asyncio
    async def test_check_identity_claims_none(self, orchestrator):
        orchestrator.llm = AsyncMock()
        orchestrator.llm.generate.return_value = "NONE"
        await orchestrator._check_identity_claims("Hello world", "p1", "id1", "c1")
>       assert orchestrator.llm.generate.called
E       AssertionError: assert False
E        +  where False = <AsyncMock name='mock.generate' id='124449822053664'>.called
E        +    where <AsyncMock name='mock.generate' id='124449822053664'> = <AsyncMock id='124449822062448'>.generate
E        +      where <AsyncMock id='124449822062448'> = <core.orchestrator.MegaBotOrchestrator object at 0x712fbb71bec0>.llm

tests/test_coverage_completion_final.py:301: AssertionError
---------------------------- Captured stdout setup -----------------------------
WARNING: memU not found at /tmp/mock_repos/memU. Using functional fallback mock.
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.6-final-0 ________________

Name                                    Stmts   Miss  Cover   Missing
---------------------------------------------------------------------
adapters/__init__.py                        3      0   100%
adapters/channels/__init__.py               0      0   100%
adapters/discord_adapter.py               347      4    99%   35, 38, 42, 775
adapters/mcp_adapter.py                    58      9    84%   30, 63-66, 72, 76-79
adapters/memu_adapter.py                  102      6    94%   108-115
adapters/messaging/__init__.py             15      0   100%
adapters/messaging/__main__.py              2      0   100%
adapters/messaging/imessage.py             29      0   100%
adapters/messaging/server.py              265     24    91%   303-310, 346-386
adapters/messaging/sms.py                  35      0   100%
adapters/messaging/telegram.py            103      0   100%
adapters/messaging/whatsapp.py            427     96    78%   45-47, 60-77, 88-89, 94-100, 133-135, 149, 177-181, 185-202, 249-265, 296-315, 341-357, 394-399, 408-410, 425-444, 467-493, 648-649, 655-659, 661-662, 711-713, 741, 769-772, 784, 810-813, 820, 852-856, 869
adapters/nanobot_adapter.py                74      4    95%   41-43, 120
adapters/openclaw_adapter.py               73      4    95%   20-23
adapters/push_notification_adapter.py     494      8    98%   729, 1029, 1032, 1066, 1082, 1100, 1146-1148
adapters/security/__init__.py               2      0   100%
adapters/security/tirith_guard.py          31      1    97%   43
adapters/signal_adapter.py                486      0   100%
adapters/slack_adapter.py                 246      3    99%   27, 30, 34
adapters/telegram_adapter.py              653      2    99%   1234-1235
adapters/unified_gateway.py                 5      0   100%
adapters/voice_adapter.py                  71     14    80%   15-28, 95-96, 130-131
core/__init__.py                            5      0   100%
core/admin_handler.py                     200     15    92%   108, 123, 170, 278, 318-339, 394
core/agents.py                             47      2    96%   77-80
core/config.py                            143     14    90%   26-27, 71-82, 127, 129, 144, 194, 196, 252
core/dependencies.py                       87      6    93%   54, 85, 107-108, 122-123
core/discovery.py                          24      0   100%
core/drivers.py                            90      7    92%   25, 28, 31, 34, 37, 40-41
core/instrumentation.py                    38      3    92%   50, 57, 61
core/interfaces.py                         17      0   100%
core/llm_providers.py                     268     55    79%   19, 39-42, 273-274, 359-361, 396-398, 431-469, 494-533
core/loki.py                              131      4    97%   74, 288-289, 341
core/memory/__init__.py                     6      0   100%
core/memory/backup_manager.py             107      4    96%   104-106, 112
core/memory/chat_memory.py                 94      6    94%   186-188, 203-205
core/memory/knowledge_memory.py           127     21    83%   63-65, 86-88, 119-121, 175-177, 193-195, 213-215, 239-241
core/memory/mcp_server.py                  79      2    97%   45-46
core/memory/user_identity.py               68      0   100%
core/network/__init__.py                    0      0   100%
core/network/gateway.py                   332     34    90%   103-121, 142-143, 149-151, 417-431
core/network/monitor.py                    22      1    95%   15
core/network/server.py                     22      0   100%
core/network/tunnel.py                     38      0   100%
core/orchestrator.py                      912    279    69%   179, 353, 357-365, 368-382, 385-393, 396-404, 408-429, 432-440, 443-460, 489, 537-538, 598-599, 614-615, 620, 627, 649-650, 662-663, 766-778, 789-790, 793-827, 835, 848-851, 873, 886-906, 919-922, 926-928, 932-990, 1111-1112, 1189-1275, 1329, 1370-1386, 1397, 1402-1404, 1410-1467, 1477-1501, 1530, 1535, 1537, 1646, 1675-1692, 1695-1718, 1721-1753, 1756-1768, 1775, 1909-1912, 1920, 1926-1929, 1945-1950
core/orchestrator_components.py           185     57    69%   111-125, 162-163, 169-170, 176-177, 185-186, 204-217, 224-225, 252-257, 261-266, 270-274, 278, 291-295, 308-312, 323-325, 335-336
core/permissions.py                        52      4    92%   35-36, 101-102
core/projects.py                           38      3    92%   26, 31, 53
core/rag/__init__.py                        2      0   100%
core/rag/pageindex.py                     112      8    93%   28-29, 42-43, 77-78, 110, 165
core/secrets.py                            36      5    86%   24-28
---------------------------------------------------------------------
TOTAL                                    6803    705    90%
=========================== short test summary info ============================
FAILED tests/test_coverage_completion_final.py::TestOrchestratorCoverage::test_sanitize_output_with_various_inputs
FAILED tests/test_coverage_completion_final.py::TestOrchestratorCoverage::test_check_identity_claims_none
================== 2 failed, 1167 passed in 72.07s (0:01:12) ===================
